# 统一审计组件设计文档

## 概述

本文档描述了基于 BeanPostProcessor 的统一审计实现方案。该方案简化了审计组件的架构，提供了单一、可靠、高性能的审计解决方案。

## 设计原则

### 1. 单一实现方式
- **只使用 BeanPostProcessor + MethodInterceptor**
- 移除了 AspectJ、事件机制、Web拦截器等多种实现
- 降低了复杂性和维护成本

### 2. 运行时代理
- 自动检测带有 `@Auditable` 注解的 Bean
- 使用 CGLIB 代理创建审计增强
- 支持类级别和方法级别的注解

### 3. 高性能设计
- 缓存已处理的 Bean，避免重复处理
- 跳过 Spring 内部类，减少不必要的检查
- 异步审计支持，不影响主业务性能

## 核心组件

### AuditBeanPostProcessor

统一的审计 Bean 后处理器，负责：

1. **Bean 扫描**：检测需要审计的 Bean
2. **代理创建**：为目标 Bean 创建 CGLIB 代理
3. **方法拦截**：实现完整的审计逻辑
4. **参数处理**：支持新的参数注解和传统配置
5. **异常处理**：完整的异常审计记录

#### 主要特性

```java
@Component
@RequiredArgsConstructor
public class AuditBeanPostProcessor implements BeanPostProcessor {
    
    // 核心依赖
    private final AuditService auditService;
    private final ObjectMapper objectMapper;
    
    // 性能优化
    private final Map<String, Boolean> processedBeans = new ConcurrentHashMap<>();
    
    // 内置方法拦截器
    private class AuditMethodInterceptor implements MethodInterceptor {
        // 完整的审计逻辑实现
    }
}
```

### AuditConfig

简化的配置类，只包含必要的配置：

```java
@Configuration
@EnableAsync
public class AuditConfig {
    
    @Bean("auditExecutor")
    public Executor auditExecutor() {
        // 审计专用线程池配置
    }
    
    @Bean
    public ObjectMapper auditObjectMapper() {
        // 审计数据序列化配置
    }
}
```

## 功能特性

### 1. 注解支持

#### @Auditable 主注解
```java
@Auditable(
    operation = "操作名称",
    description = "操作描述", 
    eventType = AuditEventType.CREATE,
    includeParameters = true,
    includeResult = true,
    async = true,
    condition = "#param > 0"
)
```

#### @SensitiveParam 敏感参数
```java
public void method(@SensitiveParam(strategy = MaskStrategy.EMAIL) String email) {}
```

#### @IgnoreParam 忽略参数
```java
public void method(@IgnoreParam(reason = "太大不记录") Object largeObject) {}
```

### 2. 脱敏策略

| 策略 | 说明 | 示例 |
|------|------|------|
| DEFAULT | 保留前2后2位 | `ab****yz` |
| FULL | 完全脱敏 | `****` |
| EMAIL | 邮箱脱敏 | `a***@example.com` |
| PHONE | 手机号脱敏 | `138****5678` |
| BANK_CARD | 银行卡脱敏 | `**** **** **** 1234` |
| ID_CARD | 身份证脱敏 | `1234**********5678` |
| CUSTOM | 自定义SpEL | 用户定义 |

### 3. 配置兼容性

支持多种配置方式，优先级如下：

1. **参数注解**：`@SensitiveParam`、`@IgnoreParam`
2. **索引配置**：`sensitiveParams = {0, 1}`
3. **名称配置**：`sensitiveParamNames = {"password"}`
4. **表达式配置**：`sensitiveParamExpression = "#param.contains('secret')"`

## 使用示例

### 基础使用

```java
@Service
public class UserService {
    
    @Auditable(operation = "用户登录", eventType = AuditEventType.LOGIN)
    public boolean login(String username, 
                        @SensitiveParam(strategy = MaskStrategy.FULL) String password) {
        // 登录逻辑
    }
    
    @Auditable(operation = "用户注册", eventType = AuditEventType.CREATE)
    public void register(@SensitiveParam(strategy = MaskStrategy.EMAIL) String email,
                        @IgnoreParam Object request) {
        // 注册逻辑
    }
}
```

### 类级别审计

```java
@Service
@Auditable(module = "用户服务", eventType = AuditEventType.BUSINESS_OPERATION)
public class UserService {
    
    public void method1() { /* 会被审计 */ }
    public void method2() { /* 会被审计 */ }
    
    @Auditable(operation = "特殊操作")  // 覆盖类级别配置
    public void specialMethod() { /* 使用方法级别配置 */ }
}
```

### 条件审计

```java
@Auditable(
    operation = "条件操作",
    condition = "#important == true",  // 只有重要操作才审计
    businessKey = "#userId"            // 业务标识
)
public void conditionalOperation(String userId, boolean important) {
    // 业务逻辑
}
```

## 性能特性

### 1. 启动性能
- **Bean缓存**：避免重复扫描同一个Bean
- **类型过滤**：跳过Spring内部类和系统类
- **延迟代理**：只对需要的Bean创建代理

### 2. 运行时性能
- **异步审计**：默认使用专用线程池异步记录
- **智能脱敏**：只对标记的参数进行脱敏处理
- **条件审计**：支持SpEL条件表达式，避免不必要的审计

### 3. 内存优化
- **对象复用**：复用序列化器和表达式解析器
- **垃圾回收友好**：避免创建大量临时对象

## 配置说明

### 线程池配置

```java
@Bean("auditExecutor")
public Executor auditExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(2);      // 核心线程数
    executor.setMaxPoolSize(4);       // 最大线程数  
    executor.setQueueCapacity(1000);  // 队列容量
    executor.setKeepAliveSeconds(60); // 空闲线程存活时间
    return executor;
}
```

### 序列化配置

**使用Spring Boot默认ObjectMapper：**
```yaml
# application.yml
spring:
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: Asia/Shanghai
    serialization:
      write-dates-as-timestamps: false
      fail-on-empty-beans: false
    deserialization:
      fail-on-unknown-properties: false
```

**自定义ObjectMapper（高级）：**
```java
@Configuration
public class JacksonConfig {
    
    @Bean
    @Primary
    public ObjectMapper objectMapper() {
        ObjectMapper mapper = new ObjectMapper();
        mapper.findAndRegisterModules();
        mapper.setDateFormat(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        return mapper;
    }
}
```

## 最佳实践

### 1. 注解使用
- 优先使用参数注解 `@SensitiveParam` 和 `@IgnoreParam`
- 在类级别使用 `@Auditable` 为整个服务启用审计
- 使用有意义的 `operation` 和 `description`

### 2. 性能优化
- 对于大批量操作，设置 `async = true`
- 对于大对象参数，使用 `@IgnoreParam` 忽略
- 合理使用 `condition` 避免不必要的审计

### 3. 安全考虑
- 敏感数据必须使用 `@SensitiveParam` 标记
- 选择合适的脱敏策略
- 定期审查审计日志的安全性

## 迁移指南

### 从 AspectJ 切面迁移
1. 移除 `@EnableAspectJAutoProxy` 配置
2. 删除 `AuditAspect` 相关代码
3. 确保 `AuditBeanPostProcessor` 已注册

### 从事件机制迁移
1. 删除事件监听器和发布器
2. 移除 `@EventListener` 相关代码
3. 审计逻辑已集成到 `BeanPostProcessor` 中

### 从Web拦截器迁移
1. 删除 `WebAuditInterceptor` 配置
2. 移除 `HandlerInterceptor` 实现
3. 在Controller方法上添加 `@Auditable` 注解

## 故障排除

### 常见问题

1. **Bean未被代理**
   - 检查是否添加了 `@Auditable` 注解
   - 确认Bean是由Spring管理的
   - 查看是否被缓存跳过

2. **参数脱敏不生效**
   - 检查 `enableParamAnnotations = true`（默认值）
   - 确认注解在正确的参数上
   - 查看日志中的脱敏策略应用情况

3. **性能问题**
   - 检查是否启用了异步审计
   - 查看线程池配置是否合理
   - 考虑使用条件审计减少不必要的记录

### 日志配置

```yaml
logging:
  level:
    com.abc.web.support.audit: DEBUG  # 开启审计组件调试日志
```

## 总结

统一的 BeanPostProcessor 审计方案具有以下优势：

1. **架构简单**：单一实现方式，易于理解和维护
2. **性能优秀**：异步处理，缓存优化，对业务无影响
3. **功能完整**：支持所有审计特性，兼容旧配置
4. **扩展性好**：易于添加新的脱敏策略和审计功能
5. **生产就绪**：经过优化的配置，适用于企业级应用

这个方案为企业级Java应用提供了一个可靠、高效的审计解决方案。