# 参数注解使用指南

## 概述

为了解决传统参数索引方式使用不便的问题，审计组件现在支持使用注解来标记敏感参数和忽略参数。这种方式更加直观、类型安全，且易于维护。

## 核心注解

### @SensitiveParam 敏感参数注解

用于标记方法参数中的敏感数据，这些参数在审计时将被脱敏处理。

```java
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface SensitiveParam {
    MaskStrategy strategy() default MaskStrategy.DEFAULT;
    String customExpression() default "";
    String description() default "";
}
```

#### 脱敏策略

| 策略 | 说明 | 示例 |
|------|------|------|
| `DEFAULT` | 保留前2位和后2位，中间用****代替 | `ab****yz` |
| `FULL` | 全部脱敏 | `****` |
| `EMAIL` | 保留@前1位和@后的域名 | `a***@example.com` |
| `PHONE` | 保留前3位和后4位 | `138****5678` |
| `BANK_CARD` | 保留后4位 | `**** **** **** 1234` |
| `ID_CARD` | 保留前4位和后4位 | `1234**********5678` |
| `CUSTOM` | 自定义SpEL表达式脱敏 | 自定义 |

### @IgnoreParam 忽略参数注解

用于标记不需要记录到审计日志的参数。

```java
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface IgnoreParam {
    String reason() default "";
}
```

## 使用示例

### 基础使用

```java
@Auditable(operation = "用户登录", eventType = AuditEventType.LOGIN)
public boolean login(String username, 
                    @SensitiveParam(strategy = MaskStrategy.FULL) 
                    String password) {
    // 登录逻辑
    return authenticate(username, password);
}
```

### 多种脱敏策略

```java
@Auditable(operation = "用户注册", eventType = AuditEventType.CREATE)
public void registerUser(
    String username,
    @SensitiveParam(strategy = MaskStrategy.FULL) 
    String password,
    @SensitiveParam(strategy = MaskStrategy.EMAIL) 
    String email,
    @SensitiveParam(strategy = MaskStrategy.PHONE) 
    String phone,
    @IgnoreParam(reason = "请求对象过大") 
    HttpServletRequest request) {
    // 注册逻辑
}
```

### 自定义脱敏

```java
@Auditable(operation = "更新个人信息")
public void updateProfile(
    String userId,
    @SensitiveParam(
        strategy = MaskStrategy.CUSTOM,
        customExpression = "#value.length() > 10 ? #value.substring(0, 3) + '***' + #value.substring(#value.length()-3) : '***'",
        description = "个人简介"
    ) 
    String bio) {
    // 更新逻辑
}
```

### 银行卡和身份证

```java
@Auditable(operation = "实名认证")
public void verify(
    @SensitiveParam(strategy = MaskStrategy.ID_CARD) 
    String idCard,
    @SensitiveParam(strategy = MaskStrategy.BANK_CARD) 
    String bankCard) {
    // 验证逻辑
}
```

## 配置选项

### 启用参数注解

在 `@Auditable` 注解中可以控制是否启用参数注解：

```java
@Auditable(
    operation = "示例操作",
    enableParamAnnotations = true  // 默认为true
)
public void example() {}
```

### 向前兼容

新的参数注解方式与传统配置方式完全兼容：

```java
@Auditable(
    operation = "混合配置",
    enableParamAnnotations = true,      // 启用参数注解
    sensitiveParams = {1},              // 传统索引方式
    sensitiveParamNames = {"oldParam"}, // 参数名称方式
    ignoreParams = {3}                  // 忽略索引方式
)
public void mixedConfig(
    String normal,
    String indexSensitive,              // 通过索引配置
    @SensitiveParam String annotated,   // 通过注解配置
    @IgnoreParam String ignored,        // 通过注解忽略
    String oldParam) {                  // 通过参数名配置
}
```

### 优先级

当同一个参数有多种配置时，优先级如下：

1. 参数注解 (`@SensitiveParam`、`@IgnoreParam`)
2. 传统索引配置 (`sensitiveParams`、`ignoreParams`)
3. 参数名称配置 (`sensitiveParamNames`、`ignoreParamNames`)
4. SpEL表达式配置 (`sensitiveParamExpression`)

## 最佳实践

### 1. 推荐使用参数注解

```java
// ✅ 推荐：直观、类型安全
@Auditable(operation = "登录")
public void login(@SensitiveParam String password) {}

// ❌ 不推荐：容易出错
@Auditable(operation = "登录", sensitiveParams = {0})
public void login(String password) {}
```

### 2. 合理选择脱敏策略

```java
// ✅ 根据数据类型选择合适策略
@SensitiveParam(strategy = MaskStrategy.EMAIL) String email
@SensitiveParam(strategy = MaskStrategy.PHONE) String phone
@SensitiveParam(strategy = MaskStrategy.BANK_CARD) String cardNumber

// ❌ 一律使用默认策略
@SensitiveParam String email  // 对邮箱用默认策略不够友好
```

### 3. 添加描述信息

```java
// ✅ 添加描述，便于理解
@SensitiveParam(
    strategy = MaskStrategy.CUSTOM,
    customExpression = "...",
    description = "用户密码"
) String password

@IgnoreParam(reason = "包含大量二进制数据") MultipartFile file
```

### 4. 自定义脱敏表达式

```java
// ✅ 复杂脱敏逻辑
@SensitiveParam(
    strategy = MaskStrategy.CUSTOM,
    customExpression = "#value != null && #value.length() > 6 ? " +
                      "#value.substring(0, 2) + '***' + #value.substring(#value.length()-2) : '***'"
)
```

## 扩展

如果需要新的脱敏策略，可以：

1. 在 `MaskStrategy` 枚举中添加新策略
2. 在 `DataMaskingUtils` 中实现对应的脱敏逻辑
3. 或者使用 `CUSTOM` 策略配合 SpEL 表达式

## 注意事项

1. 参数注解只在运行时生效，编译时不做检查
2. 自定义SpEL表达式执行失败时，会回退到默认脱敏策略
3. 启用参数注解扫描会有轻微性能开销，但通常可以忽略
4. 参数名称配置依赖编译时保留参数名，确保编译配置正确

## 性能建议

1. 优先使用内置脱敏策略，避免复杂的SpEL表达式
2. 对于大对象，使用 `@IgnoreParam` 避免序列化开销
3. 合理设置 `includeParameters` 开关，避免不必要的参数记录